{% extends 'a_classroom/base.html' %}
{% block title %} {{ activity.subject.course_code }} - {{ activity.title }} {% endblock %}
{% block content %}

<div class="flex flex-col h-full w-full overflow-auto student-submission">
	<div id="activity-output" class="border-r bg-gray-200 p-4">

		<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
			<span class="font-bold">Title</span>
			<span class="block mb-4 p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;">
				{{ activity.title }}
			</span>
		</div>

		<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
			<span class="font-bold">Instructions</span>
			<span class="block mb-4 p-3 bg-gray-100 rounded max-h-32 overflow-y-auto" style="scrollbar-gutter: stable;">
				{{ activity.description }}
			</span>
		</div>

		<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
			<span class="font-bold">Max Score</span>
			<div class="mb-4 p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;">
				{{ activity.max_score }}
			</div>
		</div>

		<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
			<span class="font-bold">Language</span>
			<div class="mb-4 p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;">
				{{ activity.language }}
			</div>
		</div>
		
		
		{% if activity.type == "quiz" %}
			<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
				<span class="font-bold">Max Attempt</span>
				<div class="mb-4 p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;">
					{{ activity.max_attempt }}
				</div>
			</div>
		{% endif %}

		<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
			<span class="font-bold">Due</span>
			<div class="mb-4 p-3 bg-gray-100 rounded max-h-16 overflow-y-auto" style="scrollbar-gutter: stable;">
				{{ activity.due_at }}
			</div>
		</div>
		
		<div class="flex justify-center items-center w-full">
			<button class="py-2 w-32 text-white bg-gray-800 cursor-pointer rounded hover:bg-gray-950"
				hx-get="{% url 'c_activities:edit-activity' activity.activity_id %}?type={{ activity.type }}" 
				hx-target="#activity-output" 
				hx-swap="innerHTML" 
				title="Click to edit activity">Edit Activity</button>
		</div>
	</div>

	<!-- Right Panel: Submissions & Controls -->
	<div id="output" class="flex flex-1 flex-col w-full bg-gray-200 p-4">

		<div class="overflow-y-auto" style="scrollbar-gutter: stable;">
			{% if activity_submissions %}
				{% with first_submission=activity_submissions.first %}

					<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
						<span class="font-bold">Email Address</span>
						<div class="mb-4 p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;">
							{{ first_submission.student.email }}
						</div>
					</div>

					<div class="text-left text-sm font-medium text-gray-800 sm:text-base">
						<span class="font-bold">Submitted Code</span>
						<span class="block mb-4 p-3 bg-gray-100 rounded max-h-32 overflow-y-auto" style="scrollbar-gutter: stable;">{{ first_submission.submitted_code }}</span>
					</div>

					<!-- Editable Feedback with scrollable content -->
					<div id="feedback-{{ first_submission.id }}" class="text-left text-sm font-medium text-gray-800 sm:text-base">
						<span class="font-bold">Feedback</span>
						<span class="block mb-4 p-3 bg-gray-100 rounded max-h-32 overflow-y-auto" style="scrollbar-gutter: stable;">
							{{ first_submission.feedback }}
							<button class="cursor-pointer py-1 px-2 text-white bg-gray-800 rounded hover:bg-gray-950 {% if first_submission.status == 'returned' %} opacity-50 cursor-not-allowed bg-gray-500 {% endif %}"
								hx-get="{% url 'c_activities:edit-insight' first_submission.id %}"
								hx-swap="outerHTML"
								hx-target="#feedback-{{ first_submission.id }}"
								title="Click to edit feedback"
								{% if first_submission.status == 'returned' %} disabled {% endif %}>Edit Feedback</button>
						</span>
					</div>

					<!-- Editable Score -->
					<div id="score-{{ first_submission.id }}" class="text-left text-sm font-medium text-gray-800 sm:text-base">
						<span class="font-bold">Score</span>
						<div class="p-3 bg-gray-100 rounded max-h-20 overflow-y-auto" style="scrollbar-gutter: stable;"> 
							{{ first_submission.score }}
							<button class="cursor-pointer py-1 px-2 text-white bg-gray-800 rounded hover:bg-gay-950 {% if first_submission.status == 'returned' %} opacity-50 cursor-not-allowed bg-gray-500 {% endif %}"
								hx-get="{% url 'c_activities:edit-grade' first_submission.id %}" 
								hx-swap="outerHTML" 
								hx-target="#score-{{ first_submission.id }}" 
								title="Click to edit grade"
								{% if first_submission.status == 'returned' %} disabled {% endif %}>Edit Grade</button>
						</div>
					</div>

					<!-- Return Grade button placed directly under the score -->
					<form hx-post="{% url 'c_activities:return-grade' first_submission.id %}" class="mt-2">
						{% csrf_token %}
						<button type="submit" name="action" value="return" 
						class="py-2 w-32 text-white bg-gray-800 rounded hover:bg-gray-950 {% if first_submission.status == 'returned' %} opacity-50 cursor-not-allowed bg-gray-500 {% else %} cursor-pointer hover:bg-gray-950 {% endif %}" 
						title="{% if first_submission.status == 'returned' %} Grade already returned {% else %} Click to return grade to student {% endif %}" 
						{% if first_submission.status == 'returned' %}disabled onclick="return false;"{% endif %}>
							Return Grade
						</button>
					</form>
				{% endwith %}
			{% else %}
				<p class="text-center text-sm font-medium text-gray-800 sm:text-base">No submission.</p>
			{% endif %}
		</div>
		<div class="flex justify-between items-center border-solid h-auto w-full bg-gray-200 text-sm font-medium text-gray-800 sm:text-base">
			<form hx-get="{% url 'a_classroom:prev_or_next' %}" hx-target="#output" hx-swap="innerHTML" class="w-full flex justify-center py-3">
				<input type="hidden" name="activity_id" value="{{ activity.activity_id }}">
				<input type="hidden" name="index" value="{{ index|default:0 }}">
				<button type="submit" name="action" value="previous" 
				class="flex items-center justify-center py-2 w-32 text-white bg-gray-800 cursor-pointer rounded hover:bg-gray-950"
				title="Go to previous page">Previous</button> 
			</form>
			<form hx-get="{% url 'a_classroom:prev_or_next' %}" hx-target="#output" hx-swap="innerHTML" class="w-full flex justify-center py-3">
				<input type="hidden" name="activity_id" value="{{ activity.activity_id }}">
				<input type="hidden" name="index" value="{{ index|default:0 }}">
				<button type="submit" name="action" value="next" 
				class="flex items-center justify-center py-2 w-32 text-white bg-gray-800 cursor-pointer rounded hover:bg-gray-950"
				title="Go to next page">Next</button> 
			</form>
		</div>
	</div>
</div>
{% endblock %}