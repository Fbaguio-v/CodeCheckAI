{% extends 'a_classroom/base.html' %}
{% block title %} {{ activity.subject.course_code }} - {{ activity.title }} {% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<div class="flex flex-row h-full overflow-auto ">
	<div class="w-[40%] overflow-auto flex flex-col bg-gray-100">
		<div id="activity-output" class="flex overflow-auto scrollbar-hidden flex-col justify-start border rounded h-[95%] p-4">

			<p class="pt-3 pb-4 text-2xl font-bold text-center">{{ activity.title }}</p>

			<div class="overflow-auto scrollbar-hidden">
				<p class="justify-start pb-3 pl-3 pr-3 text-xl text-left">
					<span class="font-bold">Instruction:</span> {{ activity.description }}
				</p>
			</div>

			<p class="pb-3 text-xl text-left">
				<span class="font-bold">Max score:</span> {{ activity.max_score }}
			</p>

			{% if activity.type == "quiz" %}
				<p class="pb-3 text-xl text-left">
					<span class="font-bold">Max Attempt:</span> {{ activity.max_attempt }}
				</p>
			{% endif %}

			<p class="pb-3 text-xl text-left">
				<span class="font-bold">Due:</span> {{ activity.due_at }}
			</p>
		</div>

		<div class="flex items-center justify-center pt-5 pb-5 bg-gray-100 border-2 border-gray-100 border-solid">
			<button class="h-12 px-8 text-white bg-black border-2 border-solid shadow-xl cursor-pointer rounded-xl hover:bg-gray-500 transition-colors duration-200 w-auto min-w-[140px]"
				hx-get="{% url 'c_activities:edit-activity' activity.activity_id %}?type={{ activity.type }}" 
				hx-target="#activity-output" 
				hx-swap="innerHTML" 
				title="Click to edit activity">Edit Activity</button>
		</div>
	</div>

	<!-- Right Panel (Submissions & Controls) -->
	<div id="output" class="flex flex-row w-full h-full border-2 border-solid bg-gray-200">
		<!-- Previous -->
		<div class="flex justify-center items-center border-solid h-full w-[10%] bg-gray-200">
			<form hx-get="{% url 'a_classroom:prev_or_next' %}" hx-target="#output" hx-swap="innerHTML">
				<input type="hidden" name="activity_id" value="{{ activity.activity_id }}">
				<input type="hidden" name="index" value="{{ index|default:0 }}">
				<button type="submit" name="action" value="previous" 
				class="w-20 h-12 text-white bg-black border-2 border-solid shadow-xl cursor-pointer rounded-xl hover:bg-gray-500 transition-colors duration-200"
				title="Go to previous page">Previous</button> 
			</form>
		</div>

		<div class="relative w-full h-full bg-gray-200">
			<div class="h-full overflow-y-auto pt-10 pl-5 pr-5 pb-20">
				{% if activity_submissions %}
					{% with first_submission=activity_submissions.first %}
						<p class="pb-3 text-xl text-left">
							<span class="font-bold">Email Address : </span>{{ first_submission.student.email }}
						</p>

						<p class="pb-3 text-xl text-left break-words">
							<span class="font-bold">Submitted Code : </span>
							<pre class="mt-2 p-3 bg-gray-100 rounded-lg overflow-x-auto">{{ first_submission.submitted_code }}</pre>
						</p>

						<!-- Editable Feedback with scrollable content -->
						<div id="feedback-{{ first_submission.id }}" class="pb-3 text-xl text-left">
							<span class="font-bold">Feedback : </span>
							<div class="mt-2 p-3 bg-gray-100 rounded-lg max-h-32 overflow-y-auto">
								{{ first_submission.feedback }}
							</div>
							<button class="ml-3 px-3 py-1 text-sm text-white bg-blue-600 rounded-lg shadow hover:bg-blue-800 transition-colors duration-200"
								hx-get="{% url 'c_activities:edit-insight' first_submission.id %}"
								hx-swap="outerHTML"
								hx-target="#feedback-{{ first_submission.id }}"
								title="Click to edit feedback">Edit Feedback</button>
						</div>

						<!-- Editable Score -->
						<p id="score-{{ first_submission.id }}" class="pb-3 text-xl text-left">
							<span class="font-bold">Score : </span>{{ first_submission.score }}
							<button class="ml-3 px-3 py-1 text-sm text-white bg-green-600 rounded-lg shadow hover:bg-green-800 transition-colors duration-200"
								hx-get="{% url 'c_activities:edit-grade' first_submission.id %}" 
								hx-swap="outerHTML" 
								hx-target="#score-{{ first_submission.id }}" 
								title="Click to edit grade">Edit Grade</button>
						</p>
					{% endwith %}
				{% else %}
					<p class="text-center text-lg font-semibold">No submission.</p>
				{% endif %}
			</div>

			<!-- Fixed Return Grade Button (not scrollable) -->
			{% if activity_submissions %}
				{% with first_submission=activity_submissions.first %}
					<div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 w-full flex justify-center">
						<form hx-post="{% url 'c_activities:return-grade' first_submission.id %}">
							{% csrf_token %}
							<button type="submit" name="action" value="return" 
							class="w-40 h-12 text-white bg-black border-2 border-solid shadow-xl rounded-xl {% if first_submission.status == 'returned' %}opacity-50 cursor-not-allowed bg-gray-500{% else %}cursor-pointer hover:bg-gray-500 transition-colors duration-200{% endif %}" 
							title="{% if first_submission.status == 'returned' %}Grade already returned{% else %}Click to return grade to student{% endif %}" 
							{% if first_submission.status == 'returned' %}disabled onclick="return false;"{% endif %}>
								Return Grade
							</button>
						</form>
					</div>
				{% endwith %}
			{% endif %}
		</div>

		<!-- Next -->
		<div class="flex justify-center items-center border-solid h-full w-[10%] bg-gray-200">
			<form hx-get="{% url 'a_classroom:prev_or_next' %}" hx-target="#output" hx-swap="innerHTML">
				<input type="hidden" name="activity_id" value="{{ activity.activity_id }}">
				<input type="hidden" name="index" value="{{ index|default:0 }}">
				<button type="submit" name="action" value="next" 
				class="w-20 h-12 text-white bg-black border-2 border-solid shadow-xl cursor-pointer rounded-xl hover:bg-gray-500 transition-colors duration-200"
				title="Go to next page">Next</button> 
			</form>
		</div>
	</div>
</div>

<!-- Scrollbar hidden -->
<style>
.scrollbar-hidden::-webkit-scrollbar {
	display: none;
}
.scrollbar-hidden {
	-ms-overflow-style: none;
	scrollbar-width: none;    
}
</style>
{% endblock %}